// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  username  String?  @unique
  password  String
  name      String?
  role      UserRole @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
  comments Comment[]
  passkeys PasskeyCredential[]
}

enum UserRole {
  ADMIN
}

model Project {
  id            String  @id @default(cuid())
  title         String
  slug          String  @unique
  description   String?
  companyName   String? // Optional company/brand name (display priority: companyName → primary recipient → 'Client')
  sharePassword String?
  authMode      String  @default("PASSWORD") // Authentication mode: PASSWORD, OTP, BOTH, or NONE
  guestMode     Boolean @default(false) // Allow guest access with limited view (videos only, no comments/approval)
  guestLatestOnly Boolean @default(true) // Guests can only view latest version of each video

  // Revision tracking (optional)
  enableRevisions Boolean @default(false)
  maxRevisions    Int     @default(3)

  status          ProjectStatus @default(IN_REVIEW)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  approvedAt      DateTime?
  approvedVideoId String? // ID of the video that was approved (null if not approved)

  // Comment restrictions
  restrictCommentsToLatestVersion Boolean @default(false)
  hideFeedback                    Boolean @default(false)

  // Video processing settings
  previewResolution String  @default("720p") // "720p", "1080p", "2160p"
  watermarkEnabled  Boolean @default(true) // Enable/disable watermarks for this project
  watermarkText     String? // Custom watermark text (null = use default format)

  // Asset download settings
  allowAssetDownload Boolean @default(true) // Allow clients to download video assets when project is approved

  // Client notification settings (per-project)
  // Note: Approval emails are always IMMEDIATE regardless of this setting
  clientNotificationSchedule String    @default("HOURLY") // IMMEDIATE, HOURLY, DAILY, WEEKLY
  clientNotificationTime     String? // "09:00" for daily, "Monday 09:00" for weekly
  clientNotificationDay      Int? // 0-6 for weekly (0 = Sunday)
  lastClientNotificationSent DateTime?

  createdBy   User   @relation(fields: [createdById], references: [id])
  createdById String

  videos            Video[]
  comments          Comment[]
  securityEvents    SecurityEvent[]
  analytics         VideoAnalytics[]
  recipients        ProjectRecipient[] // Multiple email recipients
  notificationQueue NotificationQueue[] // Pending notifications
}

enum ProjectStatus {
  IN_REVIEW
  APPROVED
  SHARE_ONLY
}

model ProjectRecipient {
  id                   String   @id @default(cuid())
  projectId            String
  project              Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  email                String?
  name                 String?
  isPrimary            Boolean  @default(false)
  receiveNotifications Boolean  @default(true) // Per-recipient notification toggle
  createdAt            DateTime @default(now())

  @@index([projectId])
  @@index([projectId, email])
}

model Video {
  id           String @id @default(cuid())
  projectId    String
  name         String // Name to distinguish different videos in a project (required)
  version      Int // 1, 2, 3 (for revisions)
  versionLabel String // "v1", "v2", "v3" or custom

  // Original file
  originalFileName    String
  originalFileSize    BigInt
  originalStoragePath String

  // Video metadata
  duration Float // in seconds
  width    Int
  height   Int
  fps      Float?
  codec    String?

  // Processing status
  status             VideoStatus @default(UPLOADING)
  uploadProgress     Int         @default(0) // 0-100 percentage
  processingProgress Float       @default(0)
  processingError    String?

  // Preview versions (watermarked)
  preview1080Path String?
  preview720Path  String?
  thumbnailPath   String?

  // Per-video approval
  approved   Boolean   @default(false)
  approvedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analytics VideoAnalytics[]
  assets    VideoAsset[]

  @@index([projectId, version])
  @@index([projectId, name])
}

model VideoAsset {
  id       String @id @default(cuid())
  videoId  String
  video    Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // File information
  fileName     String // Original filename (e.g., "project.prproj", "music.mp3", "photo.jpg")
  fileSize     BigInt
  fileType     String // MIME type (e.g., "application/octet-stream", "image/jpeg", "audio/mpeg")
  storagePath  String // Path in storage system
  category     String? // Optional category: "image", "audio", "project", "other"

  // Upload metadata
  uploadedBy   String? // User ID or "client" for client uploads
  uploadedByName String? // Display name of uploader

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([videoId])
  @@index([videoId, category])
}

enum VideoStatus {
  UPLOADING
  PROCESSING
  READY
  ERROR
}

model Comment {
  id           String   @id @default(cuid())
  projectId    String
  videoId      String // All comments must be video-specific
  videoVersion Int? // track which version this comment was for
  timestamp    Float? // in seconds
  content      String
  authorName   String? // made optional to allow anonymous comments
  authorEmail  String?
  isInternal   Boolean  @default(false) // true = from studio, false = from client
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Admin user tracking (for internal comments)
  userId String? // Admin user who created this comment
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Admin reply functionality
  parentId String? // if this is a reply to another comment
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([videoId])
  @@index([parentId])
  @@index([userId])
}

model NotificationQueue {
  id        String   @id @default(cuid())
  projectId String
  type      String // CLIENT_COMMENT, ADMIN_REPLY

  // Dual tracking for admin vs client notifications
  sentToClients Boolean  @default(false)
  sentToAdmins  Boolean  @default(false)
  clientSentAt  DateTime?
  adminSentAt   DateTime?

  // Retry and failure tracking
  clientAttempts Int     @default(0) // Number of send attempts to clients
  adminAttempts  Int     @default(0) // Number of send attempts to admins
  clientFailed   Boolean @default(false) // Permanently failed to send to clients
  adminFailed    Boolean @default(false) // Permanently failed to send to admins
  lastError      String? // Last error message for debugging

  data      Json // Stores: commentId, videoId, videoName, authorName, content, timestamp, isReply, etc.
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, sentToClients])
  @@index([projectId, sentToAdmins])
  @@index([sentToAdmins, createdAt])
  @@index([clientFailed, adminFailed])
}

model Settings {
  id String @id @default("default")

  // Company Branding
  companyName String? @default("Studio") // Displayed in feedback/comments

  // SMTP Email Configuration
  smtpServer      String?
  smtpPort        Int?    @default(587)
  smtpUsername    String?
  smtpPassword    String?
  smtpFromAddress String?
  smtpSecure      String? @default("STARTTLS") // Options: "STARTTLS", "TLS", "NONE"

  // Domain Configuration
  appDomain String? // e.g., "https://yourdomain.com"

  // Default Video Processing Settings
  defaultPreviewResolution String?  @default("720p")
  defaultWatermarkEnabled  Boolean  @default(true)
  defaultWatermarkText     String?

  // Project Behavior
  autoApproveProject Boolean @default(true) // Auto-approve project when all videos approved

  // Admin notification settings (global)
  // Note: Approval emails and manual admin notifications are always IMMEDIATE regardless of this setting
  adminNotificationSchedule String    @default("HOURLY") // IMMEDIATE, HOURLY, DAILY, WEEKLY
  adminNotificationTime     String? // "09:00" for daily, "Monday 09:00" for weekly
  adminNotificationDay      Int? // 0-6 for weekly (0 = Sunday)
  lastAdminNotificationSent DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SecuritySettings {
  id String @id @default("default")

  // Hotlink Protection: DISABLED, LOG_ONLY, BLOCK_STRICT
  hotlinkProtection String @default("LOG_ONLY")

  // Rate Limiting (global only - per minute)
  ipRateLimit      Int @default(1000) // requests per minute per IP (video streaming requires high limit)
  sessionRateLimit Int @default(600) // requests per minute per session (10/sec for seeking/buffering)
  passwordAttempts Int @default(5) // password attempts before lockout

  // Session Timeout (for client share sessions, not admin JWT)
  sessionTimeoutValue Int    @default(15) // Numeric value (15, 30, 1, 2, etc.)
  sessionTimeoutUnit  String @default("MINUTES") // MINUTES, HOURS, DAYS, WEEKS

  // HTTPS Enforcement (HTTPS_ENABLED env var always takes precedence if set)
  httpsEnabled Boolean @default(true) // Enable secure cookies and HSTS (default: true for production security)

  // Logging toggles
  trackAnalytics    Boolean @default(true)
  trackSecurityLogs Boolean @default(true)

  // Security Dashboard Access
  viewSecurityEvents Boolean @default(false) // Show /admin/security page in navigation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SecurityEvent {
  id       String @id @default(cuid())
  type     String // HOTLINK_DETECTED, HOTLINK_BLOCKED, RATE_LIMIT_HIT, TOKEN_SESSION_MISMATCH, SUSPICIOUS_ACTIVITY, BLOCKED_IP_ATTEMPT
  severity String @default("INFO") // INFO, WARNING, CRITICAL

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  videoId   String?
  sessionId String?
  ipAddress String?
  referer   String?

  // Additional context as JSON
  details Json?

  // Was this event auto-blocked?
  wasBlocked Boolean @default(false)

  createdAt DateTime @default(now())

  @@index([projectId, createdAt])
  @@index([type, createdAt])
  @@index([severity])
}

model VideoAnalytics {
  id String @id @default(cuid())

  videoId String
  video   Video  @relation(fields: [videoId], references: [id], onDelete: Cascade)

  projectId String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  // Event types: PAGE_VISIT, DOWNLOAD_COMPLETE
  eventType String

  createdAt DateTime @default(now())

  @@index([projectId, createdAt])
  @@index([videoId, createdAt])
  @@index([eventType])
}

model PasskeyCredential {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // WebAuthn credential data (following SimpleWebAuthn patterns)
  credentialID Bytes  @unique // Authenticator's credential ID
  publicKey    Bytes // Public key for signature verification
  counter      BigInt // Signature counter (prevents replay attacks)

  // UX and security metadata
  transports        String[] // ['internal', 'usb', 'nfc', 'ble', 'hybrid']
  deviceType        String // 'singleDevice' | 'multiDevice' (cloud-synced passkey)
  backedUp          Boolean  @default(false) // Indicates key material is backed up
  aaguid            String? // Authenticator Attestation GUID (optional)
  userAgent         String? // Browser/device info for admin reference
  credentialName    String? // User-friendly name: "MacBook Touch ID", "iPhone Passkey"

  // Security tracking
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime  @default(now())
  lastUsedIP String?

  @@index([userId])
  @@index([userId, lastUsedAt])
}
